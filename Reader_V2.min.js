function print(...t){console.log("@exReader:",...t)}function getOffsetTopByBody(t){let e=0;for(;t&&"BODY"!==t.tagname;)e+=t.offsetTop,t=t.offsetParent;return e}function scrollBack(t,e){t.scrollHeight-t.scrollTop===t.clientHeight&&(t.scrollTop-=e)}function GET(t,n,s,e=!0){var i,a;print("GET: "+t),"jsonp"==s?((i=document.createElement("script")).src=t,i.onload=function(){var t=window.jsonpdata;window.jsonpdata=null,n.call(this,t)},document.body.appendChild(i)):((a=new XMLHttpRequest).open("GET",t,e),a.onload=()=>{if(200===a.status){var i=a.responseText;let t=i,e;"json"==s&&(t=JSON.parse(i)),"html"==s&&((e=document.createElement("div")).innerHTML=i,t=e),"text"==s&&(t=i),n.call(this,t)}},a.send())}function lockScroll(t){document.body.classList.add("fixed")}function unlockScroll(t){document.body.classList.remove("fixed")}class GalleryInformation{constructor(){if(this.isGallery){var e,i,n=document.getElementById("gn")?document.getElementById("gn").innerText:"",s=document.getElementById("gd1")?document.getElementById("gd1").innerHTML.match(/url\((.*)\)/i)[1]:"",a=document.getElementById("gdd")?document.getElementById("gdd").getElementsByTagName("tr"):[],o=document.getElementsByClassName("gpc")[0]&&document.getElementsByClassName("gpc")[0].innerText.match(/(\d*?) - (\d*?) of/)?Number(document.getElementsByClassName("gpc")[0].innerText.match(/(\d*?) - (\d*?) of/)[2]):document.getElementsByClassName("gdtm").length||document.getElementsByClassName("reader-img").length,r=window.location.protocol+"//"+window.location.host+window.location.pathname,l={};for(e of a){var d=e.children[0]?e.children[0].innerText.toLowerCase().replace(" ","").replace(":",""):"",h=e.children[1]?e.children[1].innerText:"";l[d]=h}let t=1;for(i of document.getElementsByClassName("gtb")[0]?document.getElementsByClassName("gtb")[0].getElementsByTagName("a"):[]){var g=Number(i.innerText);t=g||t}this.title=n,this.cover=s,this.detail=l,this.pageNum=t,this.url=r,this.imgPerPage=o,this.imageNum=Number(l.length.match(/\d*/)[0]),print("GalleryInformation:",this)}}get isGallery(){return/\/e(x|-)hentai\.org\/g\//.test(window.location.href)}}class ImageMeta{constructor(t,e,i="",n="",s=100,a=139){this._url=i,this.nl="",this._imagePageUrl=n,this.width=s,this.height=a,this.galleryPage=t,this._state=0,this.stateProxy=null,this.index=e,this.imageWidget=null}get url(){return this._url}set url(t){-1<(this._url=t).indexOf("http")&&(this.state=4)}get imagePageUrl(){return this._imagePageUrl}set imagePageUrl(t){-1<(this._imagePageUrl=t).indexOf("hentai.org/s/")&&(this.state=2)}get state(){return this._state}set state(t){var e;-1!==this._state&&(e=this._state,this._state=t,this.stateProxy)&&e!==t&&this.stateProxy.call(this,t)}isGetPage(){return!!this.imagePageUrl}isGetUrl(){return!!this.url}loadIntoWidget(){3<this.state&&this.url?this.imageWidget.updateImageDOM():1<this.state&&this.imagePageUrl?this.callImageUrl():this.callPageUrl()}callPageUrl(){this.state=1,this.galleryPage.callPageUrl(this.imageWidget)}callImageUrl(){this.state=3,GET.call(this,this.imagePageUrl,function(t){var e=t.match(/<img id=\"img\" src=\"(.+?)\"/i)[1],t=t.match(/onclick=\"return nl\(\'(.+?)\'\)\"/i)[1];this.url=e,this.nl=t,this.imageWidget.updateImageDOM()},"text")}get isLoaded(){return!!this.url}get isShow(){}}class GalleryPage{constructor(e,i,t,n=5e3){var s=[];for(let t=0;t<i;t++)s.push(new ImageMeta(this,e*i+t));this.index=e,this.images=s,this.url=t,this.callState=0,this.callStack=new Array,this.callTimestamp=(new Date).getTime(),this.isLoaded=!1,this.timeout=n}getImagePageFromDOM(t){var e=t.getElementsByClassName("gt100")[0].getElementsByTagName("a");for(let t=0;t<e.length;t++){var i=e[t],n=i.href,i=i.getElementsByTagName("div")[0],s=Number(i.style.height.match(/\d*/))||139,i=Number(i.style.width.match(/\d*/))||100;this.images[t].imagePageUrl=n,this.images[t].height=s,this.images[t].width=i}this.isLoaded=!0,print("get image page from dom finish: page",this.index,this)}clearCallStack(){for(;0<this.callStack.length;){var t=this.callStack.shift();t.updateArea(),t.imgInfo.callImageUrl()}}callPageUrl(t){1<this.callState?t.imgInfo.callImageUrl():1==this.callState?this.callStack.push(t):(this.callState=1,this.callTimestamp=(new Date).getTime(),this.callStack.push(t),t=this.url,GET.call(this,t,function(t){var e=t.getElementsByClassName("gt100")[0].getElementsByTagName("a");for(let t=0;t<e.length;t++){var i=e[t],n=i.href,i=i.getElementsByTagName("div")[0],s=Number(i.style.height.match(/\d*/))||139,i=Number(i.style.width.match(/\d*/))||100;this.images[t].imagePageUrl=n,this.images[t].height=s,this.images[t].width=i}this.isLoaded=!0,this.clearCallStack()},"html"))}}class ImageParser{constructor(e){var t=e.imageNum,i=e.pageNum,n=[];for(let t=0;t<i;t++){var s=e.url+"?p="+t.toString();n.push(new GalleryPage(t,e.imgPerPage,s))}this.imageNum=t,this.imgPerPage=e.imgPerPage,this.galleryPages=n,this.galleryPages[0].getImagePageFromDOM(document.body)}}class Config{constructor(scriptDOM){print("reading config ..."),this.loadConfig();let scriptUrl=scriptDOM.getAttribute("src").match(/(http.*?\/)Reader.*\.js/)[1]||this.getLocalConfig("scriptUrl"),isTranslate=this.getLocalConfig("isTranslate")||scriptDOM.getAttribute("translate")||"true",isOpenBlank=this.getLocalConfig("isOpenBlank")||scriptDOM.getAttribute("openBlank")||"true",fontSize=this.getLocalConfig("fontSize")||eval(scriptDOM.getAttribute("fontsize"))||9,lineColor=this.getLocalConfig("lineColor")||eval(scriptDOM.getAttribute("line-color"))||"rgb(20,20,20)",tagFontSize=this.getLocalConfig("tagFontSize")||eval(scriptDOM.getAttribute("tag-fontsize"))||9,lazyLoadingSize=this.getLocalConfig("lazyLoadingSize")||eval(scriptDOM.getAttribute("lazy-loadingsize"))||5,isInfiniteLoading=this.getLocalConfig("isInfiniteLoading").toString()||!0;this.fontSize=Number(fontSize),this.tagFontSize=Number(tagFontSize),this.lazyLoadingSize=Number(lazyLoadingSize),this.lineColor=lineColor,this.isTranslate="true"===isTranslate||!0===isTranslate,this.isOpenBlank="true"===isOpenBlank||!0===isOpenBlank,this.scriptUrl=scriptUrl,this.isInfiniteLoading="true"===isInfiniteLoading||!0===isInfiniteLoading,this.$registers={fontSize:["文字字号","select_8_40"],tagFontSize:["标签字号","select_8_40"],lazyLoadingSize:["同时加载图片数","select_1_20"],lineColor:["分界线颜色","input"],isInfiniteLoading:["开启无限加载","bibox"],isTranslate:["是否翻译","bibox"],isOpenBlank:["是否在新标签打开画廊","bibox"]},this.saveConfig(),print("config:",this)}change(t,e){this[t]=e,this.saveConfig()}getLocalConfig(t){return t in this._config?this._config[t].toString():""}toString(){var t,e={};for(t in this)t.startsWith("_")||t.startsWith("$")||(e[t]=this[t]);return JSON.stringify(e)}saveConfig(){localStorage.setItem("ReaderConfig",this.toString())}loadConfig(){var t=localStorage.getItem("ReaderConfig")?JSON.parse(localStorage.getItem("ReaderConfig")):{};this._config=t}}class ImageWidget{constructor(t,e,i,n,s,a){if(n!==i.index)throw new Error(`ImageWidget index:${n} do not match ImageMeta index:${i.index} `);var o="//ehgt.org/g/blank.gif",r=a,l=(i.containerWidth=a,i.imageWidget=this,r/i.width*i.height),d=document.createElement("div"),h=(d.className="image-container",document.createElement("div")),g=(h.className="loading-box",document.createElement("img")),n=(g.setAttribute("id","img"+n),g.setAttribute("name","anchor"+n),g.setAttribute("order",n),g.setAttribute("style",`display:none;width:${r}px;height:${l}px;border:0px;`),g.setAttribute("class","reader-img"),g.setAttribute("src",o),g.onerror=t=>{"number"==typeof t&&(this.state=t),print("Image load fail "+this.index),this.addReloadButton().click()},g.onload=()=>{this.img.src.indexOf(this.blankImageUrl)<0&&(this.state=-1,this.imgInfo.width=this.img.naturalWidth,this.imgInfo.height=this.img.naturalHeight,this.updateArea(),this.webStructure.removeLoading(this.index),this.removeLoadButton())},i.stateProxy=t=>{print(`stateProxy: index:${this.index} state:`+this.state),this.isShow&&(1<=this.state&&this.state<6&&this.loadingBoxShow("Loading ..."),6===this.state)&&this.loadingBoxShow("Loading from the original ..."),-1===this.state&&this.loadingBoxHiden()},document.createElement("div"));n.setAttribute("class","reader-img-line"),d.appendChild(h),d.appendChild(g),d.appendChild(n),s.appendChild(d),this.imgInfo=i,this.webStructure=t,this.pageInfo=e,this.img=g,this.imgLine=n,this.loadingBox=h,this.imageContainer=d,this.containerWidth=a,this.blankImageUrl=o,this.pos=getOffsetTopByBody(this.img)||-1,this._waitingTime=2e3}get state(){return this.imgInfo.state}set state(t){this.imgInfo.state=t}get index(){return this.imgInfo.index}get isLoaded(){return-1===this.state}get isLoading(){return 5==this.state||6==this.state}get isLoadStart(){return this.isLoading||this.isLoaded}get index(){return this.imgInfo.index}get isLoaded(){return-1===this.state}get isLoading(){return 5==this.state||6==this.state}get isLoadStart(){return this.isLoading||this.isLoaded}reloadImage(){5<=this.state&&(this.imgInfo.imagePageUrl+="?nl="+this.imgInfo.nl,this.imgInfo.url="",this.imgInfo.nl=""),print(`Reloading Image: ${this.index} state: `+this.state),this.imgInfo.loadIntoWidget()}addReloadButton(){var t,e;return this.button||-1==this.state||(t=document.createElement("div"),this.button=t,e=document.createElement("i"),t.setAttribute("class","reader-image-reload-button"),e.setAttribute("class","iconfont icon-refresh"),t.appendChild(e),this.imageContainer.appendChild(t),t.onclick=t=>{this.webStructure.actionListener.cancelTouch(),this.reloadImage(),this.removeLoadButton()}),this.button}removeLoadButton(){this.button&&this.button instanceof HTMLElement&&this.button.parentElement.removeChild(this.button),this.button=null}loadingBoxShow(t){t!==this.loadingBox.innerText&&(this.loadingBox.innerText=t),this.loadingBox.style.display="block"}loadingBoxHiden(){this.loadingBox.style.display="none"}updateImageDOM(){this.img.src!==this.imgInfo.url&&-1!=this.state&&(this.state++,this.img.src=this.imgInfo.url,setTimeout(this.timeout.bind(this),this._waitingTime))}timeout(){this.isLoaded||(print(`image ${this.index} timeout`),this.addReloadButton(),this.loadingBoxHiden())}callPosRefresh(){this.webStructure.updatePosAfter(this.index)}updateArea(){var t=this.img.style.display,e=(this.img.style.display="none",this.imgInfo.containerWidth),i=e,e=e/this.imgInfo.width*this.imgInfo.height;this.img.style.height=e+"px",this.img.style.width=i+"px",this.img.style.display=t,this.callPosRefresh()}updatePos(){var t=getOffsetTopByBody(this.img);this.pos=t||-1}get isShow(){return"none"!=this.img.style.display}show(){this.webStructure.addLoading(this.index),this.img.style.display="block",this.imgLine.style.display="block",this.updatePos(),this.imgInfo.loadIntoWidget()}hide(){this.img.style.display="none"}}class StyleProxy{constructor(t){this._selector=t,this._styleDom=document.createElement("style"),this._styles={},this.isStyleChanged=!1,document.head.appendChild(this._styleDom)}setStyle(e,i,n=""){if(e instanceof Array&&i instanceof Array){if(e.length!==i.length)throw Error("keys and values do not match");for(let t=0;t<e.length;t++)this._styles[e[t]]!==""+i[t]+n&&(this._styles[e[t]]=""+i[t]+n,this.isStyleChanged=!0)}else this._styles[e]!==""+i+n&&(this._styles[e]=""+i+n,this.isStyleChanged=!0)}refresh(){if(this.isStyleChanged){let t="";for(var e in this._styles)t+=`${e}:${this._styles[e]};`;this._styleDom.innerHTML=`${this._selector}{${t}}`,this.isStyleChanged=!1}}}class ConfigProxy{constructor(t){this.config=t,this._styleProxys={},this._styleProxysSet=new Set}bindStyleProxy(t,e,i,n=""){t in this._styleProxys||(this._styleProxys[t]=new Array),this._styleProxys[t].push([e,i,n]),this._styleProxysSet.add(e)}updateStyleProxy(){for(var t in this._styleProxys)for(var e of this._styleProxys[t]){var[e,i,n]=e;e.setStyle(i,this.config[t],n)}for(var s of this._styleProxysSet)s.refresh()}getLineDOM(){var t=document.createElement("tr");return t.setAttribute("class","reader-menu-config-line "),t}getTitleDOM(t){var e=document.createElement("td");return e.setAttribute("class","reader-menu-config-title reader-menu-config-font"),e.innerText=t,e}getEditDOM(t,i){var e,n,s=document.createElement("td");if(s.setAttribute("class","reader-menu-config-edit reader-menu-config-font"),i.startsWith("input")&&((a=document.createElement("input")).setAttribute("class","reader-menu-config-font"),a.setAttribute("configname",t),a.value=this.config[t],s.appendChild(a),this.config,a.onchange=t=>{t=t.target;let e=t.value;-1<i.indexOf("number")&&(e=Number(e));t=t.getAttribute("configname");this.config.change(t,e),this.updateStyleProxy()}),i.startsWith("select")){var a=i.split("_"),o=Number(a[1]),r=Number(a[2]),l=document.createElement("select");l.setAttribute("configname",t),l.setAttribute("class","reader-menu-config-font");for(let t=o;t<=r;t++){var d=document.createElement("option");d.value=t,d.innerText=t,l.appendChild(d)}l.value=this.config[t],l.onchange=t=>{var t=t.target,e=Number(t.value),t=t.getAttribute("configname");this.config.change(t,e),this.updateStyleProxy()},s.appendChild(l)}return i.startsWith("bibox")&&(a=document.createElement("label"),o=document.createElement("label"),n=(e=this.config[t])?"":"checked",a.innerHTML=`<input type="radio" name="${t}" value="positive" ${e?"checked":""}>是`,a.setAttribute("class","reader-menu-config-font"),o.innerHTML=`<input type="radio" name="${t}" value="negative" ${n}>否`,o.setAttribute("class","reader-menu-config-font"),a.onchange=t=>{var t=t.target,e=t.getAttribute("name"),t=t.checked;this.config.change(e,t)},o.onchange=t=>{var t=t.target,e=t.getAttribute("name"),t=!t.checked;this.config.change(e,t)},s.appendChild(a),s.appendChild(o)),s}getConfigDOM(){var t,e=this.config.$registers,i=document.createElement("table");for(t in i.setAttribute("class","reader-menu-config-box"),e){var[n,s]=e[t],a=this.getLineDOM(),n=this.getTitleDOM(n),s=this.getEditDOM(t,s);a.appendChild(n),a.appendChild(s),i.appendChild(a)}return i}}class WebStructure{constructor(t,e){this.config=t.config,this.galleryInformation=e,this.loadQueue=[],this.loadingQuery=new Set,this.imageWidgets=[],this.galleryPages=[],this.resetDynamicStyle(t)}get isGallery(){return/\/e(x|-)hentai\.org\/g\//.test(window.location.href)}get isWaitingForLoad(){let t=0;for(var e of this.galleryPages)t+=e.callStack.length;return 0<t}get hasLoadingImages(){return 0<this.loadingQuery.size}get numOfLoadingImages(){return this.loadingQuery.size}addLoading(t){this.loadingQuery.add(t)}removeLoading(t){return this.loadingQuery.delete(t)}rebuildMobileStructure(e,t){print("rebuilding mobile structure ...");var i=document.createElement("meta"),n=document.getElementsByClassName("gm")[0],s=document.body,a=document.createElement("div"),o=document.createElement("div"),r=document.createElement("div"),l=document.createElement("div"),d=document.createElement("div"),h=document.createElement("img"),g=(document.createElement("canvas"),document.getElementById("gn")),c=document.getElementById("gj"),m=document.getElementById("gd3"),u=document.getElementById("gd4"),f=document.createElement("div"),p=document.getElementById("tagmenu_act"),y=document.getElementById("tagmenu_new");if(i.setAttribute("name","videoport"),i.setAttribute("content","width=device-width, initial-scale=1, maximum-scale=1"),s.style.overscrollBehaviorX="none",s.style.overflowX="hidden",document.head.appendChild(i),r.appendChild(g),r.appendChild(c),r.appendChild(m),l.appendChild(u),d.appendChild(r),n.innerHTML="",n.appendChild(h),n.appendChild(a),a.appendChild(o),a.appendChild(d),a.appendChild(f),a.appendChild(l),a.setAttribute("class","reader-title-background"),h.setAttribute("class","reader-title-cover-image"),o.setAttribute("class","reader-title-top-cover"),r.setAttribute("class","reader-title-top-detail"),l.setAttribute("class","reader-title-tag"),d.setAttribute("class","reader-title-info"),f.setAttribute("class","reader-title-horizontalLine"),o.style=`height:${Math.floor(document.body.clientWidth*(1/3))}px;`,a.style=`background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(51,51,51,0.9) ${Math.floor(document.body.clientWidth*(1/3))}px,rgba(51,51,51,1));`,p.style.fontSize=e.fontSize.toString()+"pt",h.src=t.cover,document.getElementsByClassName("gpc")[0]&&(document.getElementsByClassName("gpc")[0].style.display="none"),document.getElementById("gdo")&&(document.getElementById("gdo").style.display="none"),0<document.getElementsByClassName("gtb").length)for(var b of document.getElementsByClassName("gtb"))b.style.display="none";for(let t=0;t<y.getElementsByTagName("input").length;t++)y.getElementsByTagName("input")[t].style.fontSize;for(let t=0;t<m.childNodes.length;t++)m.childNodes[t].style.fontSize=e.fontSize.toString()+"pt";s=m.childNodes[0],s.appendChild(m.childNodes[1].childNodes[0]),s.style.display="flex",s.style.flexFlow="row nowrap",s.childNodes[0].setAttribute("style",`height:auto;width:auto;padding:10px 20px 10px 20px;margin:0px 10% 0px 0px;font-size:${e.fontSize}pt;`),m.childNodes[3].getElementsByTagName("tr")[1].childNodes[0].style="padding:0px;text-align:left;",m.childNodes[4].style.paddingLeft="0px",document.getElementById("favoritelink").style.whiteSpace="nowrap",g.onclick=function(){this.style.whiteSpace="normal"},c.onclick=function(){this.style.whiteSpace="normal"},i=document.getElementById("gdd");if(i){var w,S=i.getElementsByTagName("tbody")[0],C=[];for(w of S.getElementsByTagName("tr"))C.push(w);for(;0<C.length;){var x=document.createElement("div");let t=document.createElement("div"),e=(x.className="reader-info-detail-row",t.className="reader-info-detail-col",C.shift());e.parentElement.removeChild(e),t.appendChild(e),x.appendChild(t),0<C.length&&((t=document.createElement("div")).className="reader-info-detail-col",(e=C.shift()).parentElement.removeChild(e),t.appendChild(e),x.appendChild(t)),S.appendChild(x)}}}scollToTop(){document.body.scrollTop=document.documentElement.scrollTop=0}forceRefresh(){for(var t of this.imageWidgets)t.isLoaded||(t.img.src=t.img.src)}resetReader(){localStorage.removeItem("ReaderConfig"),document.location.href=document.location.href}initConfigStucture(t){this.configProxy=t;let e=document.createElement("div");e.setAttribute("class","reader-menu-config bottom-hidden"),e.onselectstart=function(t){return!1},e.onscroll=function(){scrollBack(e,20)},this._configContainer=e,document.body.appendChild(e)}showConfig(){function t(){this._configContainer.innerHTML="",this._configContainer.appendChild(configProxy.getConfigDOM()),this._configContainer.classList.remove("bottom-hidden"),this.isShowConfig=!0,this._configContainer.clientHeight>=this._configContainer.children[0].clientHeight&&(this._configContainer.children[0].style.height=this._configContainer.clientHeight+20+"px")}this._configContainer.classList.add("transform-anime"),t.call(this),this.showConfig=t}hideConfig(){this._configContainer&&(this._configContainer.classList.add("bottom-hidden"),this.isShowConfig=!1)}initMenuStructure(t){this.initConfigStucture(t);var t=document.createElement("div"),e=document.createElement("div"),t=(t.setAttribute("class","reader-menu top-hidden"),t.setAttribute("id","top-menu"),e.setAttribute("class","reader-menu bottom-hidden"),e.setAttribute("id","bottom-menu"),this._topMenu=t,this._bottomMenu=e,document.body.appendChild(e),document.body.onscroll=t=>{this.isShowMenu&&this.hideMenu(),this.isShowComments&&this.hideComments(),this.isShowConfig&&this.hideConfig()},document.createElement("i")),i=(t.setAttribute("class","iconfont icon-settings"),t.onclick=()=>{this.hideMenu(),this.showConfig()},document.createElement("i")),n=(i.setAttribute("class","iconfont icon-original"),i.onclick=()=>{window.location.href=window.location.origin+window.location.pathname+"?originalReader="+parseInt(Date.parse(new Date)/1e3)},document.createElement("i")),s=(n.setAttribute("class","iconfont icon-comments"),n.onclick=()=>{this.hideMenu(),this.showComments()},this.isShowMenu=!1,this.isShowConfig=!1,this.isShowComments=!1,this._comments=document.getElementById("cdiv"),this._comments.classList.add("bottom-hidden"),this._comments.onscroll=t=>{scrollBack(this._comments,20)},document.createElement("div")),s=(s.innerHTML=this._comments.innerHTML,s.style="width:100%;margin-bottom:20px;",this._comments.innerHTML="",this._comments.appendChild(s),window.scrollTo=function(){},document.createElement("i"));s.setAttribute("class","iconfont icon-refresh"),s.onclick=()=>{this.resetReader()},e.appendChild(t),e.appendChild(s),e.appendChild(i),e.appendChild(n)}showMenu(){function t(){this._topMenu.classList.remove("top-hidden"),this._bottomMenu.classList.remove("bottom-hidden"),this.isShowMenu=!0}this._topMenu.classList.add("transform-anime"),this._bottomMenu.classList.add("transform-anime"),t.call(this),this.showMenu=t}hideMenu(){this._topMenu.classList.add("top-hidden"),this._bottomMenu.classList.add("bottom-hidden"),this.isShowMenu=!1}showComments(){function t(){this._comments.classList.remove("bottom-hidden"),this.isShowComments=!0}this._comments.classList.add("transform-anime"),t.call(this);var e=this._comments.children[0];e.scrollHeight<this._comments.clientHeight&&(e.style.minHeight=this._comments.clientHeight+"px"),this.showComments=t}hideComments(){this._comments&&(this._comments.classList.add("bottom-hidden"),this.isShowComments=!1)}initImageStructure(e){print("initImageStructure");var i=e.imageNum,t=document.getElementById("gdt"),n="padding:0px;width:100%;max-width:none;margin:0px;",s=(t.style=n,document.body.clientWidth),a=document.createElement("div"),o=(a.setAttribute("id","gdt"),a.style=n,this.container=a,[]),r=[];for(let t=0;t<i;t++){var l=Math.floor(t/e.imgPerPage),d=t%e.imgPerPage,l=new ImageWidget(this,e.galleryPages[l],e.galleryPages[l].images[d],t,a,s);o.push(l),r.push([t,l])}this.imageWidgets=o,this.loadQueue=r,this.galleryPages=e.galleryPages,t.parentElement.insertBefore(a,t),t.parentElement.removeChild(t)}updatePosAfter(e){for(let t=e;t<this.imageWidgets.length;t++){if("none"==this.imageWidgets[t].img.style.display)return;this.imageWidgets[t].updatePos()}}showImage(t){t<this.imageWidgets.length?this.imageWidgets[t].show():print("@exReader")}loadStyleFile(){var t=document.createElement("link"),e=(t.rel="stylesheet",t.type="text/css",t.href=this.config.scriptUrl+"Reader_V2.min.css",document.createElement("link"));e.rel="stylesheet",e.type="text/css",e.href="//at.alicdn.com/t/font_2872755_lbcgjof8f0e.css",document.body.appendChild(t),document.body.appendChild(e)}resetDynamicStyle(t){print("resetting font size style ...");t.config;var e=new StyleProxy(".gtw,.gt,.gtl,.gt,.tag"),i=new StyleProxy("h1#gn,h1#gj,loading-box,.tc,.reader-menu-config-font,.reader-info-detail-col td,#cdiv .c6"),n=new StyleProxy("input#newtagfield,input#newtagbutton"),s=new StyleProxy("label input"),a=new StyleProxy(".reader-img-line"),e=(t.bindStyleProxy("tagFontSize",e,"font-size","pt"),t.bindStyleProxy("fontSize",i,"font-size","pt"),t.bindStyleProxy("fontSize",n,"font-size"),t.bindStyleProxy("fontSize",s,"width","pt"),t.bindStyleProxy("fontSize",s,"height","pt"),t.bindStyleProxy("lineColor",a,"background-color"),t.updateStyleProxy(),document.createElement("style"));e.innerHTML="#gn,#gj{text-overflow: ellipsis;white-space: nowrap;overflow: hidden;cursor:pointer;}input#newtagfield,input#newtagbutton{line-height:normal;}input#newtagfield{width:70%;}input#newtagbutton{width:auto;}",document.head.appendChild(e)}isFirstLoadFinished(){let e=!0;for(let t=0;t<Math.min(this.config.lazyLoadingSize,this.galleryInformation.imageNum);t++)if(!this.imageWidgets[t].isLoaded){e=!1;break}return!!e&&(print("First load finished."),this.isFirstLoadFinished=function(){return!0},!0)}getLoadStates(){var t,e=[];for(t of this.imageWidgets)e.push(t.isLoaded);return e}translate(){function e(t){let e=document.getElementsByClassName("gtl");for(var i=0;i<e.length;i++)e[i].classList.add("tag");e=document.getElementsByClassName("gtw");for(i=0;i<e.length;i++)e[i].classList.add("tag");e=document.getElementsByClassName("gt");for(var n,i=0;i<e.length;i++)e[i].classList.add("tag");for(n of e=document.getElementsByClassName("tag")){var s=n.getElementsByTagName("a")[0]||n,a=(n.setAttribute("selected",!1),s.innerText);s.innerText=t[a]||a,s.setAttribute("tagName",a),s.setAttribute("translateName",s.innerText),n.onclick=function(t){t&&t.target!=t.currentTarget&&(t=this.getElementsByTagName("a")[0],window.selectedTag==this?(t.innerText=t.getAttribute("translateName"),window.selectedTag=null):(t.innerHTML=t.getAttribute("tagName"),window.selectedTag&&((t=window.selectedTag.getElementsByTagName("a")[0]).innerText=t.getAttribute("translateName")),window.selectedTag=this))}}}window.selectedTag=null;var t=localStorage.getItem("tagDic");(t=JSON.parse(t))&&"TAGDICVERSION"in t&&Number(t.TAGDICVERSION)>=CURRENT_TAG_DICT_VERSION?e(t):GET.call(this,this.config.scriptUrl+"tag.json.js?"+parseInt(Date.parse(new Date)/1e3),function(t){localStorage.setItem("tagDic",JSON.stringify(t)),e(t)},"jsonp")}blankHyperlink(){var e=document.getElementsByTagName("a");if(e.length<1)requestAnimationFrame(this.blankHyperlink);else{let t=0;for(var i of e)/(ex|e-)hentai.org\/g\//.test(i.href)&&(t++,i.target="_blank");t?print("blank hyperlink"):requestAnimationFrame(this.blankHyperlink)}}}class ActionListener{constructor(t,e){this.lazyLoadingSize=t.lazyLoadingSize,this.webStructure=e,(this.webStructure.actionListener=this).isTouch=!1,this.config=t}get timestamp(){return(new Date).getTime()}touchEvent(t){print("touch times: "+t),1===t&&(this.webStructure.isShowMenu?this.webStructure.hideMenu():this.webStructure.showMenu(),this.webStructure.isShowComments&&this.webStructure.hideComments(),this.webStructure.isShowConfig)&&this.webStructure.hideConfig(),this.touchTimes=0}cancelTouch(){clearTimeout(this.touchEventId),this.touchTimes=0}listenTouch(){this.touchTimes=0,this.touchEventId=0;let e=t=>{clearTimeout(this.touchEventId),this.touchTimes++,this.touchEventId=setTimeout(()=>{this.touchEvent(this.touchTimes)},300)};var t=document.getElementById("gdt");t.ontouchstart=t=>{this.isTouch=!0},t.ontouchmove=t=>{this.isTouch=!1,this.cancelTouch()},t.ontouchend=t=>{this.isTouch&&e(),window.this=!1}}listenScroll(){var t=this.getFocus()+this.lazyLoadingSize;0<this.webStructure.loadQueue.length&&this.webStructure.loadQueue[0][0]<=t&&this.lazyLoad(t),this.config.isInfiniteLoading&&this.webStructure.isFirstLoadFinished()&&this.webStructure.numOfLoadingImages<this.lazyLoadingSize&&0<this.webStructure.loadQueue.length&&this.infinitLoad(this.lazyLoadingSize-this.webStructure.numOfLoadingImages),requestAnimationFrame(this.listenScroll.bind(this))}infinitLoad(e){for(let t=0;t<e;t++){print("infinite Loading:");var[,i]=this.webStructure.loadQueue.shift();if(i.show(),this.webStructure.loadQueue.length<1)return}}lazyLoad(t){for(;0<this.webStructure.loadQueue.length&&this.webStructure.loadQueue[0][0]<=t;){var[,e]=this.webStructure.loadQueue.shift();e.show()}}getFocus(){var t,e=document.documentElement.scrollTop+document.documentElement.clientHeight;let i=-1;for(t of this.webStructure.imageWidgets){if(!(t.pos<e&&t.isLoadStart))break;i+=1}return i}}print("Run Manakanemu/Exhentai Reader");var VERSION=1.3,CURRENT_TAG_DICT_VERSION=1.3,isLoadOrigin=-1<window.location.href.indexOf("originalReader="),config,configProxy,galleryInformation,webStructure,imageParser,actionListener;if(isLoadOrigin){let href=window.location.href.split("&"),orginTimestamp=parseInt(href[0].split("=")[1]);isLoadOrigin=!(2<parseInt(Date.parse(new Date)/1e3)-orginTimestamp)}isLoadOrigin||(config=new Config(document.getElementById("exReader")),configProxy=new ConfigProxy(config),galleryInformation=new GalleryInformation,webStructure=new WebStructure(configProxy,galleryInformation),config.isOpenBlank&&/e(x|-)hentai.org\/($|tag|\?)/.test(document.location.href)&&webStructure.blankHyperlink(),config.isTranslate&&webStructure.translate(),webStructure.isGallery&&(webStructure.scollToTop(),webStructure.loadStyleFile(),webStructure.rebuildMobileStructure(config,galleryInformation),webStructure.initMenuStructure(configProxy),imageParser=new ImageParser(galleryInformation),webStructure.initImageStructure(imageParser),actionListener=new ActionListener(config,webStructure),actionListener.listenScroll(),actionListener.listenTouch()));